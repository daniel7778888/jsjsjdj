<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–î–∞–Ω—è & –î–∞—Å—è - –ú–∏–ª—ã–π –ú–∏—Ä üíï</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            overflow: hidden;
            font-family: 'Comic Sans MS', 'Arial', cursive;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #87CEEB;
        }
        canvas {
            display: block;
        }
        
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        .top-panel {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .hearts-display {
            background: rgba(255, 182, 193, 0.95);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 16px;
            color: #d63384;
            text-shadow: 1px 1px 2px white;
            border: 3px solid #ff69b4;
            display: flex;
            gap: 15px;
        }
        
        .room-display {
            background: rgba(155, 89, 182, 0.95);
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 12px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
        }
        
        .room-display input {
            width: 80px;
            padding: 4px 8px;
            border-radius: 10px;
            border: none;
            font-size: 12px;
            text-align: center;
        }
        
        .room-display button {
            padding: 4px 10px;
            border-radius: 10px;
            border: none;
            background: #ff69b4;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        
        .online-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff6b6b;
        }
        .online-status.connected {
            background: #2ecc71;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .joystick-zone {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 130px;
            height: 130px;
            pointer-events: auto;
            touch-action: none;
        }
        
        .joystick-container {
            width: 110px;
            height: 110px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            border: 4px solid rgba(255, 105, 180, 0.7);
            position: relative;
        }
        
        .joystick-knob {
            position: absolute;
            width: 45px;
            height: 45px;
            background: linear-gradient(145deg, #ff69b4, #ff1493);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.6);
            pointer-events: none;
        }
        
        .action-buttons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .action-row {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.5);
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            touch-action: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.1;
        }
        .action-btn:active {
            transform: scale(0.9);
            filter: brightness(1.2);
        }
        
        .kiss-btn {
            background: linear-gradient(145deg, #ff69b4, #ff1493);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 20, 147, 0.5);
        }
        
        .punch-btn {
            background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.5);
        }
        
        .flower-btn {
            background: linear-gradient(145deg, #f39c12, #e67e22);
            color: white;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.5);
        }
        
        .switch-btn {
            position: absolute;
            top: 85px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #9b59b6, #8e44ad);
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            pointer-events: auto;
            touch-action: none;
        }
        
        .message-popup {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            border-radius: 20px;
            font-size: 22px;
            color: #d63384;
            border: 4px solid #ff69b4;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .floating-heart {
            position: absolute;
            font-size: 28px;
            animation: floatUp 2s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-100px) scale(1.5); }
        }
        
        .floating-flower {
            position: absolute;
            font-size: 32px;
            animation: floatFlower 2s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes floatFlower {
            0% { opacity: 1; transform: translateY(0) rotate(0deg) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) rotate(360deg) scale(1.3); }
        }
        
        .stars {
            position: absolute;
            font-size: 24px;
            animation: spinStars 1s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes spinStars {
            0% { opacity: 1; transform: rotate(0deg) scale(1); }
            100% { opacity: 0; transform: rotate(360deg) scale(0); }
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #ff69b4;
        }
        
        .player-indicator {
            position: absolute;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞... üíï</div>
        <div class="ui-overlay" id="ui" style="display: none;">
            <div class="top-panel">
                <div class="hearts-display">
                    <span>üíã <span id="kiss-count">0</span></span>
                    <span>üå∏ <span id="flower-count">0</span></span>
                </div>
                <div class="room-display">
                    <div class="online-status" id="online-status"></div>
                    <span>–ö–æ–º–Ω–∞—Ç–∞:</span>
                    <input type="text" id="room-input" placeholder="love" value="love">
                    <button id="join-btn">–í–æ–π—Ç–∏</button>
                </div>
            </div>
            
            <button class="switch-btn" id="switch-btn">üîÑ –Ø: <span id="current-player">–î–∞–Ω—è</span></button>
            
            <div class="joystick-zone" id="joystick-zone">
                <div class="joystick-container" id="joystick">
                    <div class="joystick-knob" id="joystick-knob"></div>
                </div>
            </div>
            
            <div class="action-buttons">
                <div class="action-row">
                    <button class="action-btn flower-btn" id="flower-btn">
                        <span style="font-size: 20px;">üå∏</span>
                        <span>–¶–≤–µ—Ç–æ–∫</span>
                    </button>
                    <button class="action-btn kiss-btn" id="kiss-btn">
                        <span style="font-size: 20px;">üíã</span>
                        <span>–ë—É—Å—å–∫–∞</span>
                    </button>
                </div>
                <div class="action-row" style="justify-content: flex-end;">
                    <button class="action-btn punch-btn" id="punch-btn">
                        <span style="font-size: 20px;">üëä</span>
                        <span>–í —Ç—ã–∫!</span>
                    </button>
                </div>
            </div>
            
            <div class="message-popup" id="message"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        // Game state
        let scene, camera, renderer;
        let danya, dasya;
        let currentPlayer = 'danya';
        let kissCount = 0;
        let flowerCount = 0;
        let joystickActive = false;
        let joystickVector = { x: 0, y: 0 };
        let knocked = { danya: false, dasya: false };
        let joystickStartPos = { x: 0, y: 0 };
        
        // Online state
        let peer = null;
        let connections = [];
        let myPeerId = null;
        let currentRoom = 'love';
        let isHost = false;
        
        // Remote player state
        let remotePlayerState = null;
        
        // Wait for libraries to load
        function waitForLibs() {
            if (typeof THREE !== 'undefined') {
                init();
            } else {
                setTimeout(waitForLibs, 100);
            }
        }
        
        // Initialize Three.js
        function init() {
            try {
                // Scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
                scene.fog = new THREE.Fog(0x87CEEB, 30, 100);
                
                // Camera
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 12, 18);
                camera.lookAt(0, 0, 0);
                
                // Renderer
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.shadowMap.enabled = true;
                document.getElementById('game-container').insertBefore(renderer.domElement, document.getElementById('loading'));
                
                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 20, 10);
                directionalLight.castShadow = true;
                scene.add(directionalLight);
                
                // Create world
                createWorld();
                
                // Create characters
                createCharacters();
                
                // Setup controls
                setupJoystick();
                setupButtons();
                setupOnline();
                
                // Hide loading, show UI
                document.getElementById('loading').style.display = 'none';
                document.getElementById('ui').style.display = 'block';
                
                // Start animation
                animate();
                
            } catch(e) {
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞: ' + e.message;
                console.error(e);
            }
        }
        
        function createWorld() {
            // Ground
            const groundGeometry = new THREE.PlaneGeometry(150, 150);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x7CCD7C });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Add trees
            for (let i = 0; i < 15; i++) {
                let x = Math.random() * 60 - 30;
                let z = Math.random() * 60 - 30;
                if (Math.abs(x) > 5 || Math.abs(z) > 5) {
                    createTree(x, z);
                }
            }
            
            // Add flowers
            for (let i = 0; i < 40; i++) {
                createFlower(
                    Math.random() * 50 - 25,
                    Math.random() * 50 - 25
                );
            }
            
            // House
            createHouse(12, -8);
            
            // Pond
            createPond(-12, 8);
            
            // Clouds
            for (let i = 0; i < 8; i++) {
                createCloud(
                    Math.random() * 80 - 40,
                    15 + Math.random() * 8,
                    Math.random() * 80 - 40
                );
            }
        }
        
        function createTree(x, z) {
            const group = new THREE.Group();
            
            const trunkGeo = new THREE.CylinderGeometry(0.3, 0.4, 2.5, 8);
            const trunkMat = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            const trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.position.y = 1.25;
            trunk.castShadow = true;
            group.add(trunk);
            
            const leavesGeo = new THREE.SphereGeometry(1.8, 8, 8);
            const leavesMat = new THREE.MeshLambertMaterial({ color: 0x228B22 });
            const leaves = new THREE.Mesh(leavesGeo, leavesMat);
            leaves.position.y = 3.5;
            leaves.castShadow = true;
            group.add(leaves);
            
            group.position.set(x, 0, z);
            scene.add(group);
        }
        
        function createFlower(x, z) {
            const colors = [0xFF69B4, 0xFFB6C1, 0xFF1493, 0xFFFF00, 0xFF6347, 0xFFFFE0];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            const flowerGeo = new THREE.SphereGeometry(0.25, 8, 8);
            const flowerMat = new THREE.MeshLambertMaterial({ color: color });
            const flower = new THREE.Mesh(flowerGeo, flowerMat);
            flower.position.set(x, 0.25, z);
            scene.add(flower);
        }
        
        function createHouse(x, z) {
            const group = new THREE.Group();
            
            const wallsGeo = new THREE.BoxGeometry(5, 3.5, 4);
            const wallsMat = new THREE.MeshLambertMaterial({ color: 0xFFE4B5 });
            const walls = new THREE.Mesh(wallsGeo, wallsMat);
            walls.position.y = 1.75;
            walls.castShadow = true;
            group.add(walls);
            
            const roofGeo = new THREE.ConeGeometry(4, 2.5, 4);
            const roofMat = new THREE.MeshLambertMaterial({ color: 0xCD5C5C });
            const roof = new THREE.Mesh(roofGeo, roofMat);
            roof.position.y = 4.75;
            roof.rotation.y = Math.PI / 4;
            roof.castShadow = true;
            group.add(roof);
            
            const doorGeo = new THREE.BoxGeometry(1, 1.8, 0.1);
            const doorMat = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            const door = new THREE.Mesh(doorGeo, doorMat);
            door.position.set(0, 0.9, 2.05);
            group.add(door);
            
            group.position.set(x, 0, z);
            scene.add(group);
        }
        
        function createPond(x, z) {
            const pondGeo = new THREE.CircleGeometry(4, 32);
            const pondMat = new THREE.MeshLambertMaterial({ 
                color: 0x4169E1, 
                transparent: true, 
                opacity: 0.8 
            });
            const pond = new THREE.Mesh(pondGeo, pondMat);
            pond.rotation.x = -Math.PI / 2;
            pond.position.set(x, 0.05, z);
            scene.add(pond);
        }
        
        function createCloud(x, y, z) {
            const group = new THREE.Group();
            const cloudMat = new THREE.MeshLambertMaterial({ color: 0xFFFFFF });
            
            for (let i = 0; i < 4; i++) {
                const size = 0.8 + Math.random() * 0.8;
                const cloudGeo = new THREE.SphereGeometry(size, 8, 8);
                const cloudPart = new THREE.Mesh(cloudGeo, cloudMat);
                cloudPart.position.set(
                    (Math.random() - 0.5) * 2.5,
                    (Math.random() - 0.5) * 0.5,
                    (Math.random() - 0.5) * 1.5
                );
                group.add(cloudPart);
            }
            
            group.position.set(x, y, z);
            group.userData = { isCloud: true, speed: 0.01 + Math.random() * 0.015 };
            scene.add(group);
        }
        
        function createCharacters() {
            danya = createCharacter(0x4169E1, 0x1E90FF, false);
            danya.position.set(-3, 0, 0);
            danya.userData.name = '–î–∞–Ω—è';
            scene.add(danya);
            
            dasya = createCharacter(0xFF69B4, 0xFF1493, true);
            dasya.position.set(3, 0, 0);
            dasya.userData.name = '–î–∞—Å—è';
            scene.add(dasya);
        }
        
        function createCharacter(bodyColor, accentColor, isGirl) {
            const group = new THREE.Group();
            
            const bodyGeo = new THREE.CylinderGeometry(0.6, 0.7, 1.4, 16);
            const bodyMat = new THREE.MeshLambertMaterial({ color: bodyColor });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 1.2;
            body.castShadow = true;
            group.add(body);
            
            const headGeo = new THREE.SphereGeometry(0.6, 16, 16);
            const headMat = new THREE.MeshLambertMaterial({ color: 0xFFDBAC });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 2.4;
            head.castShadow = true;
            group.add(head);
            
            const eyeGeo = new THREE.SphereGeometry(0.1, 8, 8);
            const eyeMat = new THREE.MeshLambertMaterial({ color: 0x000000 });
            
            const leftEye = new THREE.Mesh(eyeGeo, eyeMat);
            leftEye.position.set(-0.2, 2.5, 0.45);
            group.add(leftEye);
            
            const rightEye = new THREE.Mesh(eyeGeo, eyeMat);
            rightEye.position.set(0.2, 2.5, 0.45);
            group.add(rightEye);
            
            const blushGeo = new THREE.SphereGeometry(0.08, 8, 8);
            const blushMat = new THREE.MeshLambertMaterial({ color: 0xFFB6C1 });
            
            const leftBlush = new THREE.Mesh(blushGeo, blushMat);
            leftBlush.position.set(-0.4, 2.35, 0.4);
            group.add(leftBlush);
            
            const rightBlush = new THREE.Mesh(blushGeo, blushMat);
            rightBlush.position.set(0.4, 2.35, 0.4);
            group.add(rightBlush);
            
            const smileGeo = new THREE.TorusGeometry(0.12, 0.03, 8, 16, Math.PI);
            const smileMat = new THREE.MeshLambertMaterial({ color: 0xFF6B6B });
            const smile = new THREE.Mesh(smileGeo, smileMat);
            smile.position.set(0, 2.25, 0.5);
            smile.rotation.x = Math.PI;
            smile.rotation.z = Math.PI;
            group.add(smile);
            
            if (isGirl) {
                const bowGeo = new THREE.TorusGeometry(0.2, 0.08, 8, 16);
                const bowMat = new THREE.MeshLambertMaterial({ color: 0xFF1493 });
                const bow = new THREE.Mesh(bowGeo, bowMat);
                bow.position.set(0.3, 2.9, 0);
                bow.rotation.z = Math.PI / 4;
                group.add(bow);
                
                const hairGeo = new THREE.SphereGeometry(0.62, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2);
                const hairMat = new THREE.MeshLambertMaterial({ color: 0x4a3728 });
                const hair = new THREE.Mesh(hairGeo, hairMat);
                hair.position.y = 2.4;
                hair.rotation.x = -0.2;
                group.add(hair);
            } else {
                const hairMat = new THREE.MeshLambertMaterial({ color: 0x3d2314 });
                for (let i = 0; i < 5; i++) {
                    const hairGeo = new THREE.ConeGeometry(0.15, 0.35, 8);
                    const hair = new THREE.Mesh(hairGeo, hairMat);
                    const angle = (i / 5) * Math.PI * 2;
                    hair.position.set(
                        Math.sin(angle) * 0.25,
                        2.85,
                        Math.cos(angle) * 0.25
                    );
                    hair.rotation.z = Math.sin(angle) * 0.3;
                    hair.rotation.x = Math.cos(angle) * 0.3;
                    group.add(hair);
                }
            }
            
            const armGeo = new THREE.CylinderGeometry(0.12, 0.12, 0.7, 8);
            const armMat = new THREE.MeshLambertMaterial({ color: bodyColor });
            
            const leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.8, 1.4, 0);
            leftArm.rotation.z = 0.4;
            group.add(leftArm);
            
            const rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.8, 1.4, 0);
            rightArm.rotation.z = -0.4;
            group.add(rightArm);
            
            const legGeo = new THREE.CylinderGeometry(0.15, 0.15, 0.5, 8);
            const legMat = new THREE.MeshLambertMaterial({ color: accentColor });
            
            const leftLeg = new THREE.Mesh(legGeo, legMat);
            leftLeg.position.set(-0.25, 0.25, 0);
            group.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeo, legMat);
            rightLeg.position.set(0.25, 0.25, 0);
            group.add(rightLeg);
            
            return group;
        }
        
        function setupJoystick() {
            const joystickZone = document.getElementById('joystick-zone');
            const joystick = document.getElementById('joystick');
            const knob = document.getElementById('joystick-knob');
            const maxDist = 30;
            
            function getPos(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }
            
            function startJoystick(e) {
                e.preventDefault();
                joystickActive = true;
                const rect = joystick.getBoundingClientRect();
                joystickStartPos.x = rect.left + rect.width / 2;
                joystickStartPos.y = rect.top + rect.height / 2;
                handleJoystickMove(e);
            }
            
            function handleJoystickMove(e) {
                if (!joystickActive) return;
                e.preventDefault();
                
                const pos = getPos(e);
                let dx = pos.x - joystickStartPos.x;
                let dy = pos.y - joystickStartPos.y;
                
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > maxDist) {
                    dx = (dx / dist) * maxDist;
                    dy = (dy / dist) * maxDist;
                }
                
                knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                
                joystickVector.x = dx / maxDist;
                joystickVector.y = dy / maxDist;
            }
            
            function endJoystick(e) {
                joystickActive = false;
                knob.style.transform = 'translate(-50%, -50%)';
                joystickVector.x = 0;
                joystickVector.y = 0;
            }
            
            joystickZone.addEventListener('touchstart', startJoystick, { passive: false });
            document.addEventListener('touchmove', handleJoystickMove, { passive: false });
            document.addEventListener('touchend', endJoystick, { passive: false });
            
            joystickZone.addEventListener('mousedown', startJoystick);
            document.addEventListener('mousemove', handleJoystickMove);
            document.addEventListener('mouseup', endJoystick);
        }
        
        function setupButtons() {
            const kissBtn = document.getElementById('kiss-btn');
            const punchBtn = document.getElementById('punch-btn');
            const flowerBtn = document.getElementById('flower-btn');
            const switchBtn = document.getElementById('switch-btn');
            const joinBtn = document.getElementById('join-btn');
            
            function handleAction(fn) {
                return function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    fn();
                };
            }
            
            kissBtn.addEventListener('touchstart', handleAction(doKiss), { passive: false });
            kissBtn.addEventListener('click', handleAction(doKiss));
            
            punchBtn.addEventListener('touchstart', handleAction(doPunch), { passive: false });
            punchBtn.addEventListener('click', handleAction(doPunch));
            
            flowerBtn.addEventListener('touchstart', handleAction(giveFlower), { passive: false });
            flowerBtn.addEventListener('click', handleAction(giveFlower));
            
            switchBtn.addEventListener('touchstart', handleAction(switchPlayer), { passive: false });
            switchBtn.addEventListener('click', handleAction(switchPlayer));
            
            joinBtn.addEventListener('click', () => {
                currentRoom = document.getElementById('room-input').value || 'love';
                connectToRoom();
            });
        }
        
        function setupOnline() {
            connectToRoom();
        }
        
        function connectToRoom() {
            if (peer) {
                peer.destroy();
            }
            
            const peerId = 'danya-dasya-' + currentRoom + '-' + Math.random().toString(36).substr(2, 9);
            
            peer = new Peer(peerId, {
                debug: 0
            });
            
            peer.on('open', (id) => {
                myPeerId = id;
                document.getElementById('online-status').classList.add('connected');
                
                // Try to connect to host
                const hostId = 'danya-dasya-' + currentRoom + '-host';
                if (!myPeerId.includes('-host')) {
                    const conn = peer.connect(hostId);
                    setupConnection(conn);
                }
                
                // Also try to become host
                setTimeout(() => {
                    if (connections.length === 0) {
                        becomeHost();
                    }
                }, 2000);
            });
            
            peer.on('connection', (conn) => {
                setupConnection(conn);
            });
            
            peer.on('error', (err) => {
                console.log('Peer error:', err.type);
                if (err.type === 'peer-unavailable') {
                    becomeHost();
                }
            });
        }
        
        function becomeHost() {
            if (isHost) return;
            
            const hostId = 'danya-dasya-' + currentRoom + '-host';
            
            if (peer) peer.destroy();
            
            peer = new Peer(hostId, { debug: 0 });
            
            peer.on('open', () => {
                isHost = true;
                myPeerId = hostId;
                document.getElementById('online-status').classList.add('connected');
            });
            
            peer.on('connection', (conn) => {
                setupConnection(conn);
            });
            
            peer.on('error', (err) => {
                console.log('Host error:', err.type);
            });
        }
        
        function setupConnection(conn) {
            if (!conn) return;
            
            conn.on('open', () => {
                connections.push(conn);
                showMessage('üíï –ü–∞—Ä—Ç–Ω—ë—Ä –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!');
            });
            
            conn.on('data', (data) => {
                handleRemoteData(data);
            });
            
            conn.on('close', () => {
                connections = connections.filter(c => c !== conn);
            });
        }
        
        function sendToAll(data) {
            connections.forEach(conn => {
                if (conn.open) {
                    conn.send(data);
                }
            });
        }
        
        function handleRemoteData(data) {
            if (data.type === 'position') {
                const char = data.player === 'danya' ? danya : dasya;
                if (data.player !== currentPlayer) {
                    char.position.x = data.x;
                    char.position.z = data.z;
                    char.rotation.y = data.ry;
                }
            } else if (data.type === 'action') {
                if (data.action === 'kiss') {
                    kissCount = data.count;
                    document.getElementById('kiss-count').textContent = kissCount;
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => createFloatingHeart(), i * 100);
                    }
                    animateJump(danya);
                    animateJump(dasya);
                } else if (data.action === 'flower') {
                    flowerCount = data.count;
                    document.getElementById('flower-count').textContent = flowerCount;
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => createFloatingFlower(), i * 150);
                    }
                } else if (data.action === 'punch') {
                    knockDown(data.target);
                }
            }
        }
        
        function doKiss() {
            const player = currentPlayer === 'danya' ? danya : dasya;
            const other = currentPlayer === 'danya' ? dasya : danya;
            
            const dist = player.position.distanceTo(other.position);
            
            if (dist < 3.5) {
                kissCount++;
                document.getElementById('kiss-count').textContent = kissCount;
                showMessage('üíã –ú–£–ê–•! üíï');
                
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => createFloatingHeart(), i * 100);
                }
                
                animateJump(player);
                animateJump(other);
                
                sendToAll({ type: 'action', action: 'kiss', count: kissCount });
            } else {
                showMessage('–ü–æ–¥–æ–π–¥–∏ –±–ª–∏–∂–µ! ü•∫');
            }
        }
        
        function giveFlower() {
            const player = currentPlayer === 'danya' ? danya : dasya;
            const other = currentPlayer === 'danya' ? dasya : danya;
            
            const dist = player.position.distanceTo(other.position);
            
            if (dist < 3.5) {
                flowerCount++;
                document.getElementById('flower-count').textContent = flowerCount;
                showMessage('üå∏ –î–µ—Ä–∂–∏ —Ü–≤–µ—Ç–æ—á–µ–∫! üíï');
                
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => createFloatingFlower(), i * 150);
                }
                
                animateJump(other);
                
                sendToAll({ type: 'action', action: 'flower', count: flowerCount });
            } else {
                showMessage('–ü–æ–¥–æ–π–¥–∏ –±–ª–∏–∂–µ! üå∏');
            }
        }
        
        function doPunch() {
            const player = currentPlayer === 'danya' ? danya : dasya;
            const other = currentPlayer === 'danya' ? dasya : danya;
            const otherKey = currentPlayer === 'danya' ? 'dasya' : 'danya';
            
            const dist = player.position.distanceTo(other.position);
            
            if (dist < 3.5 && !knocked[otherKey]) {
                knockDown(otherKey);
                sendToAll({ type: 'action', action: 'punch', target: otherKey });
            } else if (dist >= 3.5) {
                showMessage('–ú–∏–º–æ! üò§');
            }
        }
        
        function knockDown(targetKey) {
            knocked[targetKey] = true;
            const target = targetKey === 'danya' ? danya : dasya;
            
            target.rotation.z = Math.PI / 2;
            target.position.y = 0.7;
            
            createStars();
            
            // –í—Å—Ç–∞—Ç—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                knocked[targetKey] = false;
                target.rotation.z = 0;
                target.position.y = 0;
            }, 3000);
        }
        
        function switchPlayer() {
            currentPlayer = currentPlayer === 'danya' ? 'dasya' : 'danya';
            document.getElementById('current-player').textContent = 
                currentPlayer === 'danya' ? '–î–∞–Ω—è' : '–î–∞—Å—è';
        }
        
        function showMessage(text) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.style.opacity = 1;
            setTimeout(() => {
                msg.style.opacity = 0;
            }, 1500);
        }
        
        function createFloatingHeart() {
            const heart = document.createElement('div');
            heart.className = 'floating-heart';
            heart.textContent = ['üíï', 'üíñ', 'üíó', 'üíò', '‚ù§Ô∏è'][Math.floor(Math.random() * 5)];
            heart.style.left = `${40 + Math.random() * 20}%`;
            heart.style.top = `${35 + Math.random() * 20}%`;
            document.getElementById('ui').appendChild(heart);
            setTimeout(() => heart.remove(), 2000);
        }
        
        function createFloatingFlower() {
            const flower = document.createElement('div');
            flower.className = 'floating-flower';
            flower.textContent = ['üå∏', 'üå∫', 'üå∑', 'üåπ', 'üíê'][Math.floor(Math.random() * 5)];
            flower.style.left = `${40 + Math.random() * 20}%`;
            flower.style.top = `${35 + Math.random() * 20}%`;
            document.getElementById('ui').appendChild(flower);
            setTimeout(() => flower.remove(), 2000);
        }
        
        function createStars() {
            for (let i = 0; i < 6; i++) {
                const star = document.createElement('div');
                star.className = 'stars';
                star.textContent = '‚≠ê';
                star.style.left = `${45 + (Math.random() - 0.5) * 25}%`;
                star.style.top = `${45 + (Math.random() - 0.5) * 25}%`;
                document.getElementById('ui').appendChild(star);
                setTimeout(() => star.remove(), 1000);
            }
        }
        
        function animateJump(character) {
            if (character.userData.jumping) return;
            character.userData.jumping = true;
            
            const startY = 0;
            let progress = 0;
            
            function jump() {
                progress += 0.08;
                character.position.y = startY + Math.sin(progress * Math.PI) * 1.2;
                
                if (progress < 1) {
                    requestAnimationFrame(jump);
                } else {
                    character.position.y = startY;
                    character.userData.jumping = false;
                }
            }
            jump();
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            const playerKey = currentPlayer;
            const player = currentPlayer === 'danya' ? danya : dasya;
            
            if (!knocked[playerKey]) {
                const speed = 0.12;
                player.position.x += joystickVector.x * speed;
                player.position.z += joystickVector.y * speed;
                
                if (joystickVector.x !== 0 || joystickVector.y !== 0) {
                    player.rotation.y = Math.atan2(joystickVector.x, joystickVector.y);
                    
                    // Send position to others
                    sendToAll({
                        type: 'position',
                        player: currentPlayer,
                        x: player.position.x,
                        z: player.position.z,
                        ry: player.rotation.y
                    });
                }
                
                player.position.x = Math.max(-35, Math.min(35, player.position.x));
                player.position.z = Math.max(-35, Math.min(35, player.position.z));
            }
            
            // Camera follow
            const centerX = (danya.position.x + dasya.position.x) / 2;
            const centerZ = (danya.position.z + dasya.position.z) / 2;
            
            camera.position.x += (centerX - camera.position.x) * 0.05;
            camera.position.z += (centerZ + 18 - camera.position.z) * 0.05;
            camera.lookAt(centerX, 1.5, centerZ);
            
            // Animate clouds
            scene.children.forEach(child => {
                if (child.userData && child.userData.isCloud) {
                    child.position.x += child.userData.speed;
                    if (child.position.x > 50) child.position.x = -50;
                }
            });
            
            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
        
        waitForLibs();
    </script>
</body>
</html>