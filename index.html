<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>DOTA Mobile 3D Online</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è –æ–Ω–ª–∞–π–Ω–∞ -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; -webkit-user-select: none; user-select: none; }
        body { overflow: hidden; background: #0a0a12; font-family: 'Segoe UI', sans-serif; }
        #gameCanvas { width: 100vw; height: 100vh; display: block; }
        
        /* --- UI –ì–ï–†–û–ï–í (–ö–†–ê–°–ò–í–´–ô) --- */
        #heroSelect {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a0a15 0%, #1a1a2e 50%, #0a0a15 100%);
            z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .select-title { color: #4af; font-size: 28px; font-weight: bold; margin-bottom: 20px; text-shadow: 0 0 20px #4af; }
        .heroes-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; max-width: 400px; }
        .hero-card {
            background: linear-gradient(180deg, rgba(30, 40, 60, 0.9) 0%, rgba(20, 25, 40, 0.95) 100%);
            border: 2px solid rgba(100, 150, 200, 0.3); border-radius: 16px; padding: 15px;
            cursor: pointer; position: relative; overflow: hidden; text-align: center;
        }
        .hero-card.fire { border-color: rgba(255, 100, 50, 0.5); }
        .hero-card.ice { border-color: rgba(100, 200, 255, 0.5); }
        .hero-card.storm { border-color: rgba(180, 100, 255, 0.5); }
        .hero-card.shadow { border-color: rgba(100, 255, 150, 0.5); }
        .hero-icon { font-size: 40px; margin-bottom: 8px; }
        .hero-name { color: #fff; font-weight: bold; margin-bottom: 5px; }
        
        /* --- –ù–ê–°–¢–†–û–ô–ö–ò --- */
        #settingsBtn {
            position: fixed; top: 15px; right: 140px; width: 40px; height: 40px;
            background: rgba(0,0,0,0.5); border: 2px solid #555; border-radius: 8px;
            color: #fff; font-size: 24px; display: none; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1000;
        }
        #settingsModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; z-index: 3000;
            align-items: center; justify-content: center;
        }
        .settings-panel {
            background: #1a1a24; border: 2px solid #4af; border-radius: 15px; padding: 25px;
            width: 300px; text-align: center; color: white;
        }
        .btn-group { display: flex; gap: 5px; margin: 10px 0 20px 0; }
        .btn-opt {
            background: #222; border: 1px solid #444; padding: 8px; border-radius: 6px; 
            flex: 1; cursor: pointer; font-size: 12px; color: #fff;
        }
        .btn-opt.active { background: #4af; color: #000; font-weight: bold; }

        /* --- –î–ñ–û–ô–°–¢–ò–ö --- */
        #joystickZone {
            position: fixed; bottom: 50px; left: 50px; width: 120px; height: 120px;
            z-index: 1000; display: none;
        }
        .joystick-bg {
            width: 100%; height: 100%; border-radius: 50%; background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3); position: relative;
        }
        .joystick-stick {
            width: 50px; height: 50px; border-radius: 50%; background: rgba(70, 170, 255, 0.8);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 10px #4af; pointer-events: none;
        }

        /* --- –ò–ì–†–û–í–û–ô –ò–ù–¢–ï–†–§–ï–ô–° --- */
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        .hero-info { position: absolute; top: 15px; left: 15px; }
        .hero-portrait { width: 50px; height: 50px; background: rgba(20,30,50,0.9); border: 2px solid #4af; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 28px; margin-bottom: 5px; }
        .hero-bar { width: 140px; height: 14px; background: #000; border: 1px solid #444; margin-bottom: 4px; border-radius: 4px; overflow: hidden; }
        .hero-bar-fill { height: 100%; transition: width 0.2s; }
        .hp-bar { background: linear-gradient(90deg, #2c5 0%, #1a4 100%); }
        .mp-bar { background: linear-gradient(90deg, #38f 0%, #26d 100%); }

        .minimap { position: absolute; top: 15px; right: 15px; width: 100px; height: 100px; background: rgba(10,10,20,0.9); border: 2px solid #4af; border-radius: 8px; }
        .minimap-dot { position: absolute; width: 6px; height: 6px; border-radius: 50%; transform: translate(-50%, -50%); }

        .abilities-panel {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; pointer-events: auto;
        }
        .ability {
            width: 60px; height: 60px; border-radius: 12px; background: rgba(0,0,0,0.6); 
            border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center;
            font-size: 26px; position: relative; cursor: pointer;
        }
        .ability.selected { transform: scale(1.1); box-shadow: 0 0 20px #4af; border-color: #fff; }
        .ability-cd { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); color: #fff; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-weight: bold; font-size: 20px; opacity: 0; }
        .ability-cd.active { opacity: 1; }

        .cancel-btn { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); padding: 10px 30px; background: #a33; border-radius: 12px; color: white; display: none; pointer-events: auto; cursor: pointer; font-weight: bold; }
        .cancel-btn.active { display: block; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a15; display: none; align-items: center; justify-content: center; color: #4af; font-size: 24px; z-index: 2500; }
    </style>
</head>
<body>
    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="heroSelect">
        <div class="select-title">–í–´–ë–û–† –ì–ï–†–û–Ø</div>
        <div class="heroes-grid">
            <div class="hero-card fire" onclick="startGame('fire')">
                <div class="hero-icon">üî•</div>
                <div class="hero-name">–ò–Ω—Ñ–µ—Ä–Ω–æ</div>
                <div style="font-size:12px; color:#aaa">–ú–∞–≥ –æ–≥–Ω—è ‚Ä¢ –£—Ä–æ–Ω</div>
            </div>
            <div class="hero-card ice" onclick="startGame('ice')">
                <div class="hero-icon">‚ùÑÔ∏è</div>
                <div class="hero-name">–§—Ä–æ—Å—Ç–∏—è</div>
                <div style="font-size:12px; color:#aaa">–õ–µ–¥—è–Ω–æ–π –º–∞–≥ ‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å</div>
            </div>
            <div class="hero-card storm" onclick="startGame('storm')">
                <div class="hero-icon">‚ö°</div>
                <div class="hero-name">–í–æ–ª—å—Ç–µ–∫—Å</div>
                <div style="font-size:12px; color:#aaa">–ú–æ–ª–Ω–∏–∏ ‚Ä¢ –°—Ç–∞–Ω</div>
            </div>
            <div class="hero-card shadow" onclick="startGame('shadow')">
                <div class="hero-icon">üíÄ</div>
                <div class="hero-name">–£–º–±—Ä–∞</div>
                <div style="font-size:12px; color:#aaa">–¢—å–º–∞ ‚Ä¢ –í–∞–º–ø–∏—Ä–∏–∑–º</div>
            </div>
        </div>
    </div>

    <!-- –ú–ï–ù–Æ –ù–ê–°–¢–†–û–ï–ö -->
    <div id="settingsModal">
        <div class="settings-panel">
            <div style="font-size:20px; font-weight:bold; margin-bottom:15px">–ù–ê–°–¢–†–û–ô–ö–ò</div>
            
            <div style="text-align:left; color:#888; font-size:12px">–ì–†–ê–§–ò–ö–ê</div>
            <div class="btn-group">
                <div class="btn-opt" onclick="setGraphics('low')" id="gfx-low">–ù–ò–ó–ö–ê–Ø</div>
                <div class="btn-opt active" onclick="setGraphics('high')" id="gfx-high">–í–´–°–û–ö–ê–Ø</div>
            </div>

            <div style="text-align:left; color:#888; font-size:12px">–£–ü–†–ê–í–õ–ï–ù–ò–ï</div>
            <div class="btn-group">
                <div class="btn-opt active" onclick="setControl('tap')" id="ctrl-tap">–¢–ê–ü–´</div>
                <div class="btn-opt" onclick="setControl('joy')" id="ctrl-joy">–î–ñ–û–ô–°–¢–ò–ö</div>
            </div>

            <div class="btn-opt" style="background:#c33; border:none; margin-top:10px" onclick="toggleSettings()">–ó–ê–ö–†–´–¢–¨</div>
        </div>
    </div>

    <div id="loading">–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£...</div>
    <canvas id="gameCanvas"></canvas>

    <!-- UI –ò–ì–†–´ -->
    <div id="settingsBtn" onclick="toggleSettings()">‚öôÔ∏è</div>
    
    <div id="joystickZone">
        <div class="joystick-bg"><div class="joystick-stick" id="joyStick"></div></div>
    </div>

    <div id="ui">
        <div class="hero-info">
            <div class="hero-portrait" id="heroPortrait">?</div>
            <div class="hero-bar"><div class="hero-bar-fill hp-bar" id="hpBar" style="width: 100%"></div></div>
            <div class="hero-bar"><div class="hero-bar-fill mp-bar" id="mpBar" style="width: 100%"></div></div>
        </div>
        
        <div class="minimap">
            <div class="minimap-dot" style="background:#4af" id="mmHero"></div>
        </div>

        <div class="abilities-panel" id="abilitiesPanel"></div>
        <div class="cancel-btn" id="cancelBtn">‚úï –û–¢–ú–ï–ù–ê</div>
    </div>

    <script>
        // === –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –û–ù–õ–ê–ô–ù–ê ===
        const socket = io();
        let mySocketId = null;
        let otherPlayers = {}; 
        let isHost = false;

        // === –î–ê–ù–ù–´–ï –ì–ï–†–û–ï–í (–ü–æ–ª–Ω—ã–µ) ===
        const HEROES = {
            fire: {
                name: '–ò–Ω—Ñ–µ—Ä–Ω–æ', icon: 'üî•', hp: 550, mp: 450,
                color: 0xff6633, bodyColor: 0xcc3300, glowColor: 0xff4400,
                abilities: [
                    { key:'q', icon:'‚òÑÔ∏è', mana:60, cd:5, color:0xff6633 },
                    { key:'w', icon:'üî•', mana:80, cd:8, color:0xff4400 },
                    { key:'e', icon:'üí£', mana:70, cd:6, color:0xff8800 },
                    { key:'r', icon:'ü¶Ö', mana:200, cd:30, color:0xffaa00 }
                ]
            },
            ice: {
                name: '–§—Ä–æ—Å—Ç–∏—è', icon: '‚ùÑÔ∏è', hp: 500, mp: 500,
                color: 0x44aaff, bodyColor: 0x2266cc, glowColor: 0x66ddff,
                abilities: [
                    { key:'q', icon:'üå®Ô∏è', mana:55, cd:4, color:0x66ddff },
                    { key:'w', icon:'üßä', mana:100, cd:12, color:0x88eeff },
                    { key:'e', icon:'üåä', mana:75, cd:7, color:0x44aaff },
                    { key:'r', icon:'‚ùÑÔ∏è', mana:180, cd:25, color:0xffffff }
                ]
            },
            storm: {
                name: '–í–æ–ª—å—Ç–µ–∫—Å', icon: '‚ö°', hp: 480, mp: 550,
                color: 0xaa66ff, bodyColor: 0x6633cc, glowColor: 0xcc88ff,
                abilities: [
                    { key:'q', icon:'‚ö°', mana:50, cd:3, color:0xffff44 },
                    { key:'w', icon:'üîó', mana:90, cd:9, color:0xaa88ff },
                    { key:'e', icon:'üí®', mana:80, cd:6, color:0x88ffff },
                    { key:'r', icon:'üå™Ô∏è', mana:220, cd:35, color:0x9966ff }
                ]
            },
            shadow: {
                name: '–£–º–±—Ä–∞', icon: 'üíÄ', hp: 600, mp: 400,
                color: 0x44ff88, bodyColor: 0x226644, glowColor: 0x66ffaa,
                abilities: [
                    { key:'q', icon:'üëª', mana:65, cd:5, color:0x44ff88 },
                    { key:'w', icon:'ü¶á', mana:85, cd:8, color:0x884488 },
                    { key:'e', icon:'üåÄ', mana:60, cd:5, color:0x333366 },
                    { key:'r', icon:'üï≥Ô∏è', mana:200, cd:30, color:0x220044 }
                ]
            }
        };

        // === –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ===
        const CONFIG = { MAP_SIZE: 50, HERO_SPEED: 0.12 };
        let selectedHeroType = null;
        let heroData = null;
        
        const state = {
            hp: 0, maxHp: 0, mp: 0, maxMp: 0,
            moveTarget: null, selectedAbility: null,
            cooldowns: { 0:0, 1:0, 2:0, 3:0 },
            joystickActive: false,
            joystickVector: { x:0, y:0 }
        };
        
        const settings = { graphics: 'high', control: 'tap' };

        // === THREE.JS ===
        const canvas = document.getElementById('gameCanvas');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a12);
        
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 100);
        camera.position.set(0, 25, 20);

        // –û—Å–≤–µ—â–µ–Ω–∏–µ (–∏–∑ –∫—Ä–∞—Å–∏–≤–æ–π –≤–µ—Ä—Å–∏–∏)
        scene.add(new THREE.AmbientLight(0x334466, 0.6));
        const mainLight = new THREE.DirectionalLight(0xffeedd, 1.3);
        mainLight.position.set(20, 40, 20);
        mainLight.castShadow = true;
        mainLight.shadow.mapSize.width = 2048;
        mainLight.shadow.mapSize.height = 2048;
        scene.add(mainLight);

        // –ü–æ–ª –∏ –°–µ—Ç–∫–∞
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(CONFIG.MAP_SIZE, CONFIG.MAP_SIZE),
            new THREE.MeshStandardMaterial({ color: 0x101520, roughness: 0.85 })
        );
        floor.rotation.x = -Math.PI/2;
        floor.receiveShadow = true;
        scene.add(floor);
        scene.add(new THREE.GridHelper(CONFIG.MAP_SIZE, CONFIG.MAP_SIZE/2, 0x2a4a6a, 0x1a2a40));

        // –ß–∞—Å—Ç–∏—Ü—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è
        const particlesGeom = new THREE.BufferGeometry();
        const pCount = 200;
        const pPos = new Float32Array(pCount * 3);
        for(let i=0; i<pCount; i++) {
            pPos[i*3] = (Math.random()-0.5)*CONFIG.MAP_SIZE;
            pPos[i*3+1] = Math.random()*10;
            pPos[i*3+2] = (Math.random()-0.5)*CONFIG.MAP_SIZE;
        }
        particlesGeom.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        const particles = new THREE.Points(particlesGeom, new THREE.PointsMaterial({
            color: 0x4488ff, size: 0.15, transparent: true, opacity: 0.5, blending: THREE.AdditiveBlending
        }));
        scene.add(particles);

        let hero = null;
        let moveIndicator = new THREE.Mesh(
            new THREE.RingGeometry(0.4, 0.5, 32),
            new THREE.MeshBasicMaterial({ color: 0x44ff88, transparent: true, opacity: 0.8 })
        );
        moveIndicator.rotation.x = -Math.PI/2;
        moveIndicator.visible = false;
        scene.add(moveIndicator);

        // === –°–û–ó–î–ê–ù–ò–ï –ü–ï–†–°–û–ù–ê–ñ–ê (–ö–†–ê–°–ò–í–ê–Ø –í–ï–†–°–ò–Ø) ===
        function createHeroMesh(type, isMine) {
            const hData = HEROES[type];
            const group = new THREE.Group();

            // –¢–µ–ª–æ
            const bodyMat = new THREE.MeshStandardMaterial({
                color: hData.bodyColor, roughness: 0.3,
                emissive: hData.color, emissiveIntensity: 0.2
            });
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.38, 0.48, 1.5, 16), bodyMat);
            body.position.y = 0.75;
            body.castShadow = true;
            group.add(body);

            // –ü–ª–∞—â
            const cloak = new THREE.Mesh(new THREE.ConeGeometry(0.65, 1.1, 16), 
                new THREE.MeshStandardMaterial({ color: hData.bodyColor, roughness: 0.5 }));
            cloak.position.y = 0.55;
            group.add(cloak);

            // –ì–æ–ª–æ–≤–∞
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.32), new THREE.MeshStandardMaterial({ color: 0xffddbb }));
            head.position.y = 1.8;
            group.add(head);

            // –ö–∞–ø—é—à–æ–Ω
            const hood = new THREE.Mesh(new THREE.SphereGeometry(0.42, 20, 20, 0, 6.3, 0, 1.9), 
                new THREE.MeshStandardMaterial({ color: hData.bodyColor, side: THREE.DoubleSide }));
            hood.position.y = 1.88;
            hood.rotation.x = -0.25;
            group.add(hood);

            // –ü–æ—Å–æ—Ö —Å –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–º
            const staff = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.08, 2.8), new THREE.MeshStandardMaterial({ color: 0x5B3A20 }));
            staff.position.set(0.55, 1.4, 0);
            staff.rotation.z = 0.12;
            group.add(staff);

            const crystal = new THREE.Mesh(new THREE.OctahedronGeometry(0.28), 
                new THREE.MeshStandardMaterial({ color: hData.glowColor, emissive: hData.color, emissiveIntensity: 2 }));
            crystal.position.set(0.6, 2.8, 0);
            group.add(crystal);

            // –ö–æ–ª—å—Ü–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è
            const ringColor = isMine ? 0x00ff00 : 0xff3333;
            const ring = new THREE.Mesh(new THREE.RingGeometry(0.8, 0.9, 32), 
                new THREE.MeshBasicMaterial({ color: ringColor, transparent: true, opacity: 0.6 }));
            ring.rotation.x = -Math.PI/2;
            ring.position.y = 0.05;
            group.add(ring);

            scene.add(group);
            return group;
        }

        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï ===
        const raycaster = new THREE.Raycaster();
        
        function getGroundPoint(x, y) {
            const mouse = new THREE.Vector2((x/window.innerWidth)*2-1, -(y/window.innerHeight)*2+1);
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(floor);
            return intersects.length > 0 ? intersects[0].point : null;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π
        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            if(settings.control === 'joy' && state.joystickActive) return;
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive:false});
        
        canvas.addEventListener('mousedown', e => {
            if(settings.control === 'joy' && state.joystickActive) return;
            handleInput(e.clientX, e.clientY);
        });

        function handleInput(x, y) {
            const point = getGroundPoint(x, y);
            if(!point) return;

            if(state.selectedAbility !== null) {
                castAbility(point);
            } else if(settings.control === 'tap') {
                state.moveTarget = point;
                moveIndicator.position.copy(point);
                moveIndicator.position.y = 0.1;
                moveIndicator.visible = true;
                showTapEffect(point);
            }
        }

        // –î–∂–æ–π—Å—Ç–∏–∫
        const joyZone = document.getElementById('joystickZone');
        const stick = document.getElementById('joyStick');
        let joyTouchId = null;
        let joyCenter = {x:0, y:0};

        joyZone.addEventListener('touchstart', e => {
            e.preventDefault();
            const t = e.changedTouches[0];
            joyTouchId = t.identifier;
            const rect = joyZone.getBoundingClientRect();
            joyCenter = {x: rect.left+rect.width/2, y: rect.top+rect.height/2};
            state.joystickActive = true;
            state.moveTarget = null;
            updateJoystick(t.clientX, t.clientY);
        }, {passive:false});

        joyZone.addEventListener('touchmove', e => {
            e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === joyTouchId) {
                    updateJoystick(e.changedTouches[i].clientX, e.changedTouches[i].clientY);
                }
            }
        }, {passive:false});

        const endJoy = (e) => {
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === joyTouchId) {
                    state.joystickActive = false;
                    state.joystickVector = {x:0, y:0};
                    stick.style.transform = `translate(-50%, -50%)`;
                    joyTouchId = null;
                }
            }
        };
        joyZone.addEventListener('touchend', endJoy);

        function updateJoystick(x, y) {
            const dx = x - joyCenter.x;
            const dy = y - joyCenter.y;
            const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 35);
            const angle = Math.atan2(dy, dx);
            const mx = Math.cos(angle)*dist;
            const my = Math.sin(angle)*dist;
            stick.style.transform = `translate(calc(-50% + ${mx}px), calc(-50% + ${my}px))`;
            state.joystickVector = { x: mx/35, y: my/35 };
        }

        // === –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ===
        function startGame(type) {
            selectedHeroType = type;
            heroData = HEROES[type];
            state.maxHp = heroData.hp;
            state.hp = heroData.hp;
            state.maxMp = heroData.mp;
            state.mp = heroData.mp;

            document.getElementById('heroSelect').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('heroPortrait').textContent = heroData.icon;

            // –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£
            socket.emit('joinGame', {
                heroType: type,
                hp: state.hp,
                maxHp: state.maxHp
            });
        }

        // –û—Ç–≤–µ—Ç—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        socket.on('setHost', (val) => { isHost = val; });

        socket.on('currentPlayers', (players) => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            document.getElementById('settingsBtn').style.display = 'flex';
            
            mySocketId = socket.id;
            
            // –°–æ–∑–¥–∞–µ–º —Å–µ–±—è
            hero = createHeroMesh(selectedHeroType, true);
            
            // –°–æ–∑–¥–∞–µ–º –¥—Ä—É–≥–∏—Ö
            Object.values(players).forEach(p => {
                if(p.id !== mySocketId) {
                    const other = createHeroMesh(p.heroType, false);
                    other.position.set(p.x, 0, p.z);
                    otherPlayers[p.id] = other;
                }
            });

            createAbilitiesUI();
            animate();
        });

        socket.on('newPlayer', (p) => {
            const other = createHeroMesh(p.heroType, false);
            other.position.set(p.x, 0, p.z);
            otherPlayers[p.id] = other;
        });

        socket.on('playerMoved', (p) => {
            if(otherPlayers[p.id]) {
                const mesh = otherPlayers[p.id];
                mesh.position.set(p.x, 0, p.z);
                mesh.rotation.y = p.rot;
                // –ê–Ω–∏–º–∞—Ü–∏—è —Ö–æ–¥—å–±—ã —É –¥—Ä—É–≥–∏—Ö (—É–ø—Ä–æ—â–µ–Ω–Ω–æ - –Ω–∞–∫–ª–æ–Ω)
                mesh.rotation.z = Math.sin(Date.now()*0.01)*0.05;
            }
        });

        socket.on('playerDisconnected', (id) => {
            if(otherPlayers[id]) {
                scene.remove(otherPlayers[id]);
                delete otherPlayers[id];
            }
        });

        socket.on('remoteAbility', (data) => {
            // –≠—Ñ—Ñ–µ–∫—Ç –æ—Ç –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
            createExplosion(data.target, 0xffffff); 
        });

        // === –°–ü–û–°–û–ë–ù–û–°–¢–ò ===
        function createAbilitiesUI() {
            const panel = document.getElementById('abilitiesPanel');
            panel.innerHTML = '';
            heroData.abilities.forEach((ab, i) => {
                const el = document.createElement('div');
                el.className = 'ability';
                el.innerHTML = `${ab.icon}<div class="ability-cd" id="cd${i}"></div>`;
                el.onclick = (e) => { e.stopPropagation(); selectAbility(i); };
                panel.appendChild(el);
            });
            document.getElementById('cancelBtn').onclick = cancelAbility;
        }

        function selectAbility(idx) {
            if(state.cooldowns[idx] > 0 || state.mp < heroData.abilities[idx].mana) return;
            state.selectedAbility = idx;
            document.querySelectorAll('.ability').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.ability')[idx].classList.add('selected');
            document.getElementById('cancelBtn').classList.add('active');
        }

        function cancelAbility() {
            state.selectedAbility = null;
            document.querySelectorAll('.ability').forEach(el => el.classList.remove('selected'));
            document.getElementById('cancelBtn').classList.remove('active');
        }

        function castAbility(target) {
            const idx = state.selectedAbility;
            const ability = heroData.abilities[idx];
            
            state.mp -= ability.mana;
            state.cooldowns[idx] = ability.cd;
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
            createExplosion(target, ability.color);
            socket.emit('abilityUsed', { abilityIndex: idx, target: target });
            
            cancelAbility();
        }

        function createExplosion(pos, color) {
            // –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
            for(let i=0; i<10; i++) {
                const m = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({color: color}));
                m.position.copy(pos);
                m.position.y = 1;
                // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è "–≤—ã—Å—Ç—Ä–µ–ª–∞" –≤–≤–µ—Ä—Ö
                scene.add(m);
                setTimeout(()=>scene.remove(m), 500);
            }
            // –í—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–µ–∫—Å—Ç (–¥–ª—è —Ç–µ—Å—Ç–∞)
            showDamage(pos, "–ë–ê–ú!", color);
        }

        function showDamage(pos, text, color) {
            const div = document.createElement('div');
            div.textContent = text;
            div.style.position = 'fixed';
            div.style.color = '#'+color.toString(16);
            div.style.fontWeight = 'bold';
            div.style.textShadow = '0 0 5px #000';
            div.style.pointerEvents = 'none';
            
            const v = pos.clone(); v.y += 2; v.project(camera);
            div.style.left = ((v.x+1)/2*window.innerWidth) + 'px';
            div.style.top = ((-v.y+1)/2*window.innerHeight) + 'px';
            
            document.body.appendChild(div);
            setTimeout(()=>div.remove(), 1000);
        }

        function showTapEffect(pos) {
            const div = document.createElement('div');
            div.style.position = 'fixed';
            div.style.width = '30px'; div.style.height = '30px';
            div.style.border = '2px solid #4af'; div.style.borderRadius = '50%';
            
            const v = pos.clone(); v.project(camera);
            div.style.left = ((v.x+1)/2*window.innerWidth) + 'px';
            div.style.top = ((-v.y+1)/2*window.innerHeight) + 'px';
            div.style.transform = 'translate(-50%, -50%)';
            
            document.body.appendChild(div);
            setTimeout(()=>div.remove(), 300);
        }

        // === –ù–ê–°–¢–†–û–ô–ö–ò ===
        function toggleSettings() {
            const el = document.getElementById('settingsModal');
            el.style.display = el.style.display==='flex'?'none':'flex';
        }
        function setGraphics(lvl) {
            document.getElementById('gfx-low').classList.toggle('active', lvl==='low');
            document.getElementById('gfx-high').classList.toggle('active', lvl==='high');
            if(lvl==='high') { renderer.setPixelRatio(window.devicePixelRatio); mainLight.castShadow=true; }
            else { renderer.setPixelRatio(0.8); mainLight.castShadow=false; }
        }
        function setControl(type) {
            settings.control = type;
            document.getElementById('ctrl-tap').classList.toggle('active', type==='tap');
            document.getElementById('ctrl-joy').classList.toggle('active', type==='joy');
            document.getElementById('joystickZone').style.display = type==='joy'?'block':'none';
        }

        // === –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ ===
        let lastTime = 0;
        let updateTimer = 0;

        function animate(time) {
            requestAnimationFrame(animate);
            const delta = (time - lastTime)/1000 || 0;
            lastTime = time;

            if(!hero) return;

            // –î–≤–∏–∂–µ–Ω–∏–µ
            let moved = false;
            
            if(settings.control === 'joy' && state.joystickActive) {
                const speed = CONFIG.HERO_SPEED * 3; 
                hero.position.x += state.joystickVector.x * speed;
                hero.position.z += state.joystickVector.y * speed;
                hero.lookAt(hero.position.x + state.joystickVector.x, 0.75, hero.position.z + state.joystickVector.y);
                moved = true;
                moveIndicator.visible = false;
            } else if(settings.control === 'tap' && state.moveTarget) {
                const dir = new THREE.Vector3().subVectors(state.moveTarget, hero.position);
                dir.y = 0;
                if(dir.length() > 0.2) {
                    dir.normalize();
                    hero.position.add(dir.multiplyScalar(CONFIG.HERO_SPEED));
                    hero.lookAt(state.moveTarget.x, 0.75, state.moveTarget.z);
                    moved = true;
                } else {
                    state.moveTarget = null;
                    moveIndicator.visible = false;
                }
            }
            
            // –ö–∞–º–µ—Ä–∞ —Å–ª–µ–¥–∏—Ç –∑–∞ –≥–µ—Ä–æ–µ–º
            camera.position.x += (hero.position.x - camera.position.x) * 0.1;
            camera.position.z += (hero.position.z + 20 - camera.position.z) * 0.1;
            camera.lookAt(hero.position.x, 0, hero.position.z);

            // –†–µ–≥–µ–Ω –º–∞–Ω—ã
            if(state.mp < state.maxMp) state.mp += delta * 5;

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–Ω–µ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ)
            updateTimer += delta;
            if(updateTimer > 0.05 && moved) {
                socket.emit('playerUpdate', {
                    x: hero.position.x,
                    z: hero.position.z,
                    rot: hero.rotation.y,
                    hp: state.hp
                });
                updateTimer = 0;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            document.getElementById('hpBar').style.width = (state.hp/state.maxHp*100)+'%';
            document.getElementById('mpBar').style.width = (state.mp/state.maxMp*100)+'%';
            
            // –ö—É–ª–¥–∞—É–Ω—ã
            heroData.abilities.forEach((ab, i) => {
                if(state.cooldowns[i] > 0) {
                    state.cooldowns[i] -= delta;
                    document.getElementById('cd'+i).textContent = Math.ceil(state.cooldowns[i]);
                    document.getElementById('cd'+i).classList.add('active');
                } else {
                    document.getElementById('cd'+i).classList.remove('active');
                }
            });

            // –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞
            document.getElementById('mmHero').style.left = (50 + hero.position.x)+'px';
            document.getElementById('mmHero').style.top = (50 - hero.position.z)+'px';

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
