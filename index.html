<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>DOTA Mobile 3D Online</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –æ–Ω–ª–∞–π–Ω–∞ -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        body { overflow: hidden; background: #0a0a12; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #gameCanvas { width: 100vw; height: 100vh; display: block; }
        
        /* === –ò–ù–¢–ï–†–§–ï–ô–° –ì–ï–†–û–ï–í (–¢–í–û–ô –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô) === */
        #heroSelect {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a0a15 0%, #1a1a2e 50%, #0a0a15 100%);
            z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .select-title { color: #4af; font-size: 28px; font-weight: bold; margin-bottom: 10px; text-shadow: 0 0 30px rgba(68, 170, 255, 0.5); letter-spacing: 4px; }
        .select-subtitle { color: #888; font-size: 14px; margin-bottom: 30px; }
        .heroes-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; max-width: 360px; width: 100%; }
        
        .hero-card {
            background: linear-gradient(180deg, rgba(30, 40, 60, 0.9) 0%, rgba(20, 25, 40, 0.95) 100%);
            border: 2px solid rgba(100, 150, 200, 0.3); border-radius: 16px; padding: 15px;
            cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .hero-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%; background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, transparent 100%); pointer-events: none; }
        .hero-card:active { transform: scale(0.95); }
        .hero-card.fire { border-color: rgba(255, 100, 50, 0.5); }
        .hero-card.ice { border-color: rgba(100, 200, 255, 0.5); }
        .hero-card.storm { border-color: rgba(180, 100, 255, 0.5); }
        .hero-card.shadow { border-color: rgba(100, 255, 150, 0.5); }
        
        .hero-icon { font-size: 40px; text-align: center; margin-bottom: 8px; }
        .hero-name { color: #fff; font-size: 16px; font-weight: bold; text-align: center; margin-bottom: 4px; }
        .hero-class { color: #888; font-size: 11px; text-align: center; margin-bottom: 10px; }
        .hero-abilities { display: flex; justify-content: center; gap: 6px; }
        .hero-ability-icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); }
        .hero-stats { margin-top: 10px; display: flex; justify-content: center; gap: 12px; font-size: 10px; color: #aaa; }
        .hero-stat { display: flex; align-items: center; gap: 3px; }
        
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        .minimap { position: absolute; top: 15px; right: 15px; width: 110px; height: 110px; background: rgba(10, 10, 20, 0.9); border: 2px solid rgba(100, 180, 255, 0.5); border-radius: 8px; overflow: hidden; }
        .minimap-grid { position: absolute; width: 100%; height: 100%; background-image: linear-gradient(rgba(100, 180, 255, 0.15) 1px, transparent 1px), linear-gradient(90deg, rgba(100, 180, 255, 0.15) 1px, transparent 1px); background-size: 11px 11px; }
        .minimap-dot { position: absolute; width: 8px; height: 8px; border-radius: 50%; transform: translate(-50%, -50%); }
        .minimap-hero { background: #4af; box-shadow: 0 0 8px #4af; }
        .minimap-enemy { background: #f55; box-shadow: 0 0 8px #f55; }
        
        .abilities-panel { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; padding: 14px 18px; background: linear-gradient(180deg, rgba(15, 20, 35, 0.95) 0%, rgba(25, 35, 55, 0.95) 100%); border-radius: 18px; border: 2px solid rgba(100, 180, 255, 0.3); box-shadow: 0 5px 30px rgba(0, 0, 0, 0.6); pointer-events: auto; }
        .ability { width: 60px; height: 60px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: transform 0.15s, box-shadow 0.15s; border: 2px solid rgba(255, 255, 255, 0.3); }
        .ability:active { transform: scale(0.92); }
        .ability.selected { transform: scale(1.15); box-shadow: 0 0 30px currentColor; border-color: #fff; z-index: 10; }
        .ability-icon { font-size: 26px; pointer-events: none; }
        .ability-key { font-size: 8px; color: rgba(255,255,255,0.8); font-weight: bold; pointer-events: none; margin-top: 2px; }
        .ability-mana { position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%); color: #fff; font-size: 9px; font-weight: bold; padding: 1px 6px; border-radius: 6px; pointer-events: none; white-space: nowrap; }
        .ability-cd { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: #fff; opacity: 0; pointer-events: none; border-radius: 10px; }
        .ability-cd.active { opacity: 1; }
        
        .ability-targeting { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); padding: 12px 24px; background: rgba(20, 30, 50, 0.95); border: 2px solid rgba(100, 180, 255, 0.5); border-radius: 12px; color: #fff; font-size: 14px; font-weight: bold; display: none; box-shadow: 0 5px 30px rgba(0, 100, 200, 0.4); }
        .ability-targeting.active { display: block; }
        
        .hero-info { position: absolute; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 5px; }
        .hero-portrait { width: 50px; height: 50px; background: rgba(20, 30, 50, 0.9); border: 2px solid rgba(100, 180, 255, 0.5); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 5px; position: relative; }
        .hero-bar { width: 140px; height: 18px; background: rgba(0, 0, 0, 0.7); border-radius: 9px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.2); position: relative; }
        .hero-bar-fill { height: 100%; transition: width 0.3s ease; }
        .hp-bar .hero-bar-fill { background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%); }
        .mp-bar .hero-bar-fill { background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); }
        .hero-bar-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 9px; font-weight: bold; color: #fff; text-shadow: 0 1px 3px #000; }
        .hero-level { position: absolute; bottom: -5px; right: -5px; width: 22px; height: 22px; background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: #000; border: 2px solid #fff; }
        
        .damage-popup { position: fixed; font-weight: bold; text-shadow: 2px 2px 4px #000, -1px -1px 2px #000; pointer-events: none; animation: damageFloat 1.2s ease-out forwards; z-index: 100; }
        .damage-popup.normal { color: #ffd700; font-size: 18px; }
        .damage-popup.ability { color: #ff66ff; font-size: 24px; }
        .damage-popup.heal { color: #44ff88; font-size: 20px; }
        @keyframes damageFloat { 0% { transform: translateY(0) scale(1.3); opacity: 1; } 100% { transform: translateY(-70px) scale(0.7); opacity: 0; } }
        
        .cancel-btn { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); padding: 10px 30px; background: linear-gradient(180deg, rgba(120, 30, 30, 0.9) 0%, rgba(80, 20, 20, 0.9) 100%); border: 2px solid rgba(255, 100, 100, 0.5); border-radius: 12px; color: #fff; font-size: 14px; font-weight: bold; display: none; pointer-events: auto; cursor: pointer; }
        .cancel-btn.active { display: block; }
        
        /* === –ù–û–í–û–ï: –ù–ê–°–¢–†–û–ô–ö–ò –ò –î–ñ–û–ô–°–¢–ò–ö === */
        #settingsBtn {
            position: fixed; top: 15px; right: 140px; width: 40px; height: 40px;
            background: rgba(0,0,0,0.5); border: 2px solid #555; border-radius: 8px;
            color: #fff; font-size: 24px; display: none; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1000; pointer-events: auto;
        }
        #settingsModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; z-index: 3000;
            align-items: center; justify-content: center;
        }
        .settings-panel {
            background: #1a1a24; border: 2px solid #4af; border-radius: 15px; padding: 25px;
            width: 300px; text-align: center; color: white;
        }
        .btn-group { display: flex; gap: 5px; margin: 10px 0 20px 0; }
        .btn-opt {
            background: #222; border: 1px solid #444; padding: 8px; border-radius: 6px; 
            flex: 1; cursor: pointer; font-size: 12px; color: #fff;
        }
        .btn-opt.active { background: #4af; color: #000; font-weight: bold; }

        #joystickZone {
            position: fixed; bottom: 50px; left: 50px; width: 120px; height: 120px;
            z-index: 1000; display: none; pointer-events: auto;
        }
        .joystick-bg {
            width: 100%; height: 100%; border-radius: 50%; background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3); position: relative;
        }
        .joystick-stick {
            width: 50px; height: 50px; border-radius: 50%; background: rgba(70, 170, 255, 0.8);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 10px #4af; pointer-events: none;
        }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a15; display: none; align-items: center; justify-content: center; z-index: 2500; flex-direction: column; color: #4af; font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="heroSelect">
        <div class="select-title">–í–´–ë–ï–†–ò –ì–ï–†–û–Ø</div>
        <div class="select-subtitle">–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä + –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</div>
        
        <div class="heroes-grid">
            <div class="hero-card fire" onclick="startGame('fire')">
                <div class="hero-icon">üî•</div>
                <div class="hero-name">–ò–Ω—Ñ–µ—Ä–Ω–æ</div>
                <div class="hero-class">–û–≥–Ω–µ–Ω–Ω—ã–π –º–∞–≥ ‚Ä¢ –£—Ä–æ–Ω</div>
                <div class="hero-abilities"><div class="hero-ability-icon">‚òÑÔ∏è</div><div class="hero-ability-icon">üî•</div><div class="hero-ability-icon">üí£</div><div class="hero-ability-icon">ü¶Ö</div></div>
            </div>
            <div class="hero-card ice" onclick="startGame('ice')">
                <div class="hero-icon">‚ùÑÔ∏è</div>
                <div class="hero-name">–§—Ä–æ—Å—Ç–∏—è</div>
                <div class="hero-class">–õ–µ–¥—è–Ω–æ–π –º–∞–≥ ‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å</div>
                <div class="hero-abilities"><div class="hero-ability-icon">üå®Ô∏è</div><div class="hero-ability-icon">üßä</div><div class="hero-ability-icon">üåä</div><div class="hero-ability-icon">‚ùÑÔ∏è</div></div>
            </div>
            <div class="hero-card storm" onclick="startGame('storm')">
                <div class="hero-icon">‚ö°</div>
                <div class="hero-name">–í–æ–ª—å—Ç–µ–∫—Å</div>
                <div class="hero-class">–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å –º–æ–ª–Ω–∏–π ‚Ä¢ –°—Ç–∞–Ω</div>
                <div class="hero-abilities"><div class="hero-ability-icon">‚ö°</div><div class="hero-ability-icon">üîó</div><div class="hero-ability-icon">üí®</div><div class="hero-ability-icon">üå™Ô∏è</div></div>
            </div>
            <div class="hero-card shadow" onclick="startGame('shadow')">
                <div class="hero-icon">üíÄ</div>
                <div class="hero-name">–£–º–±—Ä–∞</div>
                <div class="hero-class">–¢—ë–º–Ω—ã–π –º–∞–≥ ‚Ä¢ –í–∞–º–ø–∏—Ä–∏–∑–º</div>
                <div class="hero-abilities"><div class="hero-ability-icon">üëª</div><div class="hero-ability-icon">ü¶á</div><div class="hero-ability-icon">üåÄ</div><div class="hero-ability-icon">üï≥Ô∏è</div></div>
            </div>
        </div>
    </div>
    
    <!-- –ú–ï–ù–Æ –ù–ê–°–¢–†–û–ï–ö -->
    <div id="settingsModal">
        <div class="settings-panel">
            <div style="font-size:20px; font-weight:bold; margin-bottom:15px">–ù–ê–°–¢–†–û–ô–ö–ò</div>
            
            <div style="text-align:left; color:#888; font-size:12px">–ì–†–ê–§–ò–ö–ê</div>
            <div class="btn-group">
                <div class="btn-opt" onclick="setGraphics('low')" id="gfx-low">–ù–ò–ó–ö–ê–Ø</div>
                <div class="btn-opt active" onclick="setGraphics('high')" id="gfx-high">–í–´–°–û–ö–ê–Ø</div>
            </div>

            <div style="text-align:left; color:#888; font-size:12px">–£–ü–†–ê–í–õ–ï–ù–ò–ï</div>
            <div class="btn-group">
                <div class="btn-opt active" onclick="setControl('tap')" id="ctrl-tap">–¢–ê–ü–´</div>
                <div class="btn-opt" onclick="setControl('joy')" id="ctrl-joy">–î–ñ–û–ô–°–¢–ò–ö</div>
            </div>

            <div class="btn-opt" style="background:#c33; border:none; margin-top:10px" onclick="toggleSettings()">–ó–ê–ö–†–´–¢–¨</div>
        </div>
    </div>

    <div id="loading">–ó–ê–ì–†–£–ó–ö–ê...</div>
    <canvas id="gameCanvas"></canvas>
    
    <!-- –î–ñ–û–ô–°–¢–ò–ö -->
    <div id="joystickZone">
        <div class="joystick-bg"><div class="joystick-stick" id="joyStick"></div></div>
    </div>
    
    <!-- –ö–ù–û–ü–ö–ê –ù–ê–°–¢–†–û–ï–ö -->
    <div id="settingsBtn" onclick="toggleSettings()">‚öôÔ∏è</div>

    <div id="ui">
        <div class="hero-info">
            <div class="hero-portrait" id="heroPortrait">?</div>
            <div class="hero-bar hp-bar"><div class="hero-bar-fill" id="hpBar" style="width: 100%"></div><div class="hero-bar-text"><span id="hpText">550/550</span></div></div>
            <div class="hero-bar mp-bar"><div class="hero-bar-fill" id="mpBar" style="width: 100%"></div><div class="hero-bar-text"><span id="mpText">450/450</span></div></div>
        </div>
        
        <div class="minimap">
            <div class="minimap-grid"></div>
            <div class="minimap-dot minimap-hero" id="mmHero"></div>
        </div>
        
        <div class="abilities-panel" id="abilitiesPanel"></div>
        <div class="ability-targeting" id="targetingHint">üéØ –¢—è–Ω–∏ –∫ —Ü–µ–ª–∏ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è</div>
        <div class="cancel-btn" id="cancelBtn">‚úï –û–¢–ú–ï–ù–ê</div>
    </div>

    <script>
        // ============ –û–ù–õ–ê–ô–ù –ò –ù–ê–°–¢–†–û–ô–ö–ò ============
        const socket = io();
        let mySocketId = null;
        let otherPlayers = {};
        const settings = { graphics: 'high', control: 'tap' };
        
        // ============ –ì–ï–†–û–ò (–¢–í–û–ô –ö–û–î) ============
        const HEROES = {
            fire: {
                name: '–ò–Ω—Ñ–µ—Ä–Ω–æ', icon: 'üî•', hp: 550, mp: 450,
                color: 0xff6633, bodyColor: 0xcc3300, glowColor: 0xff4400,
                abilities: [
                    { key:'q', icon:'‚òÑÔ∏è', name:'–ú–ï–¢–ï–û–†–ò–¢', mana:60, cd:5, radius:4, color:0xff6633, type:'meteor' },
                    { key:'w', icon:'üî•', name:'–°–¢–ï–ù–ê', mana:80, cd:8, radius:5, color:0xff4400, type:'firewall' },
                    { key:'e', icon:'üí£', name:'–ë–û–ú–ë–ê', mana:70, cd:6, radius:4.5, color:0xff8800, type:'bomb' },
                    { key:'r', icon:'ü¶Ö', name:'–§–ï–ù–ò–ö–°', mana:200, cd:30, radius:5, color:0xffaa00, type:'phoenix' }
                ]
            },
            ice: {
                name: '–§—Ä–æ—Å—Ç–∏—è', icon: '‚ùÑÔ∏è', hp: 500, mp: 500,
                color: 0x44aaff, bodyColor: 0x2266cc, glowColor: 0x66ddff,
                abilities: [
                    { key:'q', icon:'üå®Ô∏è', name:'–®–ò–ü–´', mana:55, cd:4, radius:3.5, color:0x66ddff, type:'iceSpikes' },
                    { key:'w', icon:'üßä', name:'–ó–ê–ú–û–†–û–ó–ö–ê', mana:100, cd:12, radius:2.5, color:0x88eeff, type:'freeze' },
                    { key:'e', icon:'üåä', name:'–í–û–õ–ù–ê', mana:75, cd:7, radius:3, color:0x44aaff, type:'iceWave' },
                    { key:'r', icon:'‚ùÑÔ∏è', name:'–¢–Æ–†–¨–ú–ê', mana:180, cd:25, radius:8, color:0xffffff, type:'icePrison' }
                ]
            },
            storm: {
                name: '–í–æ–ª—å—Ç–µ–∫—Å', icon: '‚ö°', hp: 480, mp: 550,
                color: 0xaa66ff, bodyColor: 0x6633cc, glowColor: 0xcc88ff,
                abilities: [
                    { key:'q', icon:'‚ö°', name:'–ú–û–õ–ù–ò–Ø', mana:50, cd:3, radius:2.5, color:0xffff44, type:'lightning' },
                    { key:'w', icon:'üîó', name:'–¶–ï–ü–¨', mana:90, cd:9, radius:3, color:0xaa88ff, type:'chainLightning' },
                    { key:'e', icon:'üí®', name:'–†–´–í–û–ö', mana:80, cd:6, radius:2, color:0x88ffff, type:'blink' },
                    { key:'r', icon:'üå™Ô∏è', name:'–¢–û–†–ù–ê–î–û', mana:220, cd:35, radius:4, color:0x9966ff, type:'tornado' }
                ]
            },
            shadow: {
                name: '–£–º–±—Ä–∞', icon: 'üíÄ', hp: 600, mp: 400,
                color: 0x44ff88, bodyColor: 0x226644, glowColor: 0x66ffaa,
                abilities: [
                    { key:'q', icon:'üëª', name:'–ü–û–ì–õ–û–©–ï–ù–ò–ï', mana:65, cd:5, radius:3, color:0x44ff88, type:'lifesteal' },
                    { key:'w', icon:'ü¶á', name:'–†–û–ô', mana:85, cd:8, radius:4, color:0x884488, type:'batSwarm' },
                    { key:'e', icon:'üåÄ', name:'–®–ê–ì', mana:60, cd:5, radius:0, color:0x333366, type:'shadowStep' },
                    { key:'r', icon:'üï≥Ô∏è', name:'–î–´–†–ê', mana:200, cd:30, radius:7, color:0x220044, type:'blackHole' }
                ]
            }
        };

        const CONFIG = { MAP_SIZE: 50, HERO_SPEED: 0.12 };
        let selectedHeroType = null;
        let heroData = null;
        
        const state = {
            hp: 0, maxHp: 0, mp: 0, maxMp: 0,
            moveTarget: null, selectedAbility: null, isDragging: false,
            cooldowns: { q:0, w:0, e:0, r:0 },
            joystickActive: false, joystickVector: {x:0, y:0}
        };

        // ============ THREE.JS ============
        const canvas = document.getElementById('gameCanvas');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x080810);
        scene.fog = new THREE.FogExp2(0x080810, 0.012);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 200);
        camera.position.set(0, 28, 24);

        scene.add(new THREE.AmbientLight(0x334466, 0.6));
        const mainLight = new THREE.DirectionalLight(0xffeedd, 1.3);
        mainLight.position.set(20, 40, 20);
        mainLight.castShadow = true;
        mainLight.shadow.mapSize.width = 2048;
        mainLight.shadow.mapSize.height = 2048;
        scene.add(mainLight);

        // Map
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(CONFIG.MAP_SIZE, CONFIG.MAP_SIZE), new THREE.MeshStandardMaterial({ color: 0x101520, roughness: 0.85 }));
        floor.rotation.x = -Math.PI/2;
        floor.receiveShadow = true;
        scene.add(floor);
        scene.add(new THREE.GridHelper(CONFIG.MAP_SIZE, CONFIG.MAP_SIZE/2, 0x2a4a6a, 0x1a2a40));

        // Pillars & Particles
        [[-1,-1],[-1,1],[1,-1],[1,1]].forEach(([x,z]) => {
            const p = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.55, 5, 12), new THREE.MeshStandardMaterial({ color: 0x3a5a8a, emissive: 0x1a2a4a, emissiveIntensity: 0.5 }));
            p.position.set(x*CONFIG.MAP_SIZE/2, 2.5, z*CONFIG.MAP_SIZE/2);
            p.castShadow = true;
            scene.add(p);
            const orb = new THREE.Mesh(new THREE.SphereGeometry(0.35), new THREE.MeshStandardMaterial({ color: 0x88ccff, emissive: 0x4488ff, emissiveIntensity: 2 }));
            orb.position.set(x*CONFIG.MAP_SIZE/2, 5.2, z*CONFIG.MAP_SIZE/2);
            scene.add(orb);
        });

        const particlesGeom = new THREE.BufferGeometry();
        const pPos = new Float32Array(200 * 3);
        for(let i=0; i<200; i++) {
            pPos[i*3] = (Math.random()-0.5)*CONFIG.MAP_SIZE;
            pPos[i*3+1] = Math.random()*10;
            pPos[i*3+2] = (Math.random()-0.5)*CONFIG.MAP_SIZE;
        }
        particlesGeom.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        scene.add(new THREE.Points(particlesGeom, new THREE.PointsMaterial({ color: 0x4488ff, size: 0.12, transparent: true, opacity: 0.5, blending: THREE.AdditiveBlending })));

        // ============ –ì–ï–†–û–ô ============
        let hero = null;
        let abilityZone = new THREE.Mesh(new THREE.RingGeometry(2.8, 3, 32), new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.8}));
        abilityZone.rotation.x = -Math.PI/2;
        abilityZone.visible = false;
        scene.add(abilityZone);

        let moveIndicator = new THREE.Mesh(new THREE.RingGeometry(0.4, 0.5, 32), new THREE.MeshBasicMaterial({color:0x44ff88, transparent:true, opacity:0.8}));
        moveIndicator.rotation.x = -Math.PI/2;
        moveIndicator.visible = false;
        scene.add(moveIndicator);

        function createHeroMesh(heroType, isMine) {
            const data = HEROES[heroType];
            const group = new THREE.Group();
            
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.38, 0.48, 1.5, 16), new THREE.MeshStandardMaterial({color: data.bodyColor, emissive: data.color, emissiveIntensity: 0.3}));
            body.position.y = 0.75;
            body.castShadow = true;
            group.add(body);
            
            const cloak = new THREE.Mesh(new THREE.ConeGeometry(0.65, 1.1, 16), new THREE.MeshStandardMaterial({color: data.bodyColor, roughness: 0.5}));
            cloak.position.y = 0.55;
            group.add(cloak);
            
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.32), new THREE.MeshStandardMaterial({color: 0xffddbb}));
            head.position.y = 1.8;
            group.add(head);

            const hood = new THREE.Mesh(new THREE.SphereGeometry(0.42, 20, 20, 0, 6.3, 0, 1.9), new THREE.MeshStandardMaterial({color: data.bodyColor, side: THREE.DoubleSide}));
            hood.position.y = 1.88;
            hood.rotation.x = -0.25;
            group.add(hood);

            const staff = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.08, 2.8), new THREE.MeshStandardMaterial({color: 0x5B3A20}));
            staff.position.set(0.55, 1.4, 0);
            staff.rotation.z = 0.12;
            group.add(staff);

            const crystal = new THREE.Mesh(new THREE.OctahedronGeometry(0.28), new THREE.MeshStandardMaterial({color: data.glowColor, emissive: data.color, emissiveIntensity: 2}));
            crystal.position.set(0.6, 2.8, 0);
            group.add(crystal);

            // –ö–æ–ª—å—Ü–æ: –ó–µ–ª–µ–Ω–æ–µ –¥–ª—è –º–µ–Ω—è, –ö—Ä–∞—Å–Ω–æ–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö
            const ringColor = isMine ? 0x00ff00 : 0xff3333;
            const ring = new THREE.Mesh(new THREE.RingGeometry(0.8, 0.9, 32), new THREE.MeshBasicMaterial({color: ringColor, transparent:true, opacity:0.6}));
            ring.rotation.x = -Math.PI/2;
            ring.position.y = 0.05;
            group.add(ring);

            scene.add(group);
            return group;
        }

        // ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï ============
        const raycaster = new THREE.Raycaster();
        
        function getGroundPoint(x, y) {
            const mouse = new THREE.Vector2((x/window.innerWidth)*2-1, -(y/window.innerHeight)*2+1);
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(floor);
            return intersects.length > 0 ? intersects[0].point : null;
        }

        // Joystick
        const joyZone = document.getElementById('joystickZone');
        const stick = document.getElementById('joyStick');
        let joyTouchId = null, joyCenter = {x:0, y:0};

        joyZone.addEventListener('touchstart', e => {
            e.preventDefault();
            const t = e.changedTouches[0];
            joyTouchId = t.identifier;
            const r = joyZone.getBoundingClientRect();
            joyCenter = {x: r.left+r.width/2, y: r.top+r.height/2};
            state.joystickActive = true;
            state.moveTarget = null;
            updateJoystick(t.clientX, t.clientY);
        }, {passive:false});

        joyZone.addEventListener('touchmove', e => {
            e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++) if(e.changedTouches[i].identifier === joyTouchId) updateJoystick(e.changedTouches[i].clientX, e.changedTouches[i].clientY);
        }, {passive:false});

        const endJoy = (e) => {
            for(let i=0; i<e.changedTouches.length; i++) if(e.changedTouches[i].identifier === joyTouchId) {
                state.joystickActive = false;
                state.joystickVector = {x:0, y:0};
                stick.style.transform = `translate(-50%, -50%)`;
                joyTouchId = null;
            }
        };
        joyZone.addEventListener('touchend', endJoy);

        function updateJoystick(x, y) {
            const dx = x - joyCenter.x;
            const dy = y - joyCenter.y;
            const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 35);
            const angle = Math.atan2(dy, dx);
            const mx = Math.cos(angle)*dist;
            const my = Math.sin(angle)*dist;
            stick.style.transform = `translate(calc(-50% + ${mx}px), calc(-50% + ${my}px))`;
            state.joystickVector = { x: mx/35, y: my/35 };
        }

        // Taps
        canvas.addEventListener('touchstart', e => {
            if(settings.control==='joy' && state.joystickActive) return;
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        });
        canvas.addEventListener('touchmove', e => {
            if(state.selectedAbility !== null) {
                const p = getGroundPoint(e.touches[0].clientX, e.touches[0].clientY);
                if(p) { abilityZone.position.copy(p); abilityZone.position.y=0.1; }
            }
        });
        canvas.addEventListener('touchend', e => {
            if(state.selectedAbility !== null) {
                const p = getGroundPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                if(p) castAbility(state.selectedAbility, p);
            }
        });
        
        canvas.addEventListener('mousedown', e => handleInput(e.clientX, e.clientY));

        function handleInput(x, y) {
            if(settings.control==='joy' && state.joystickActive) return;
            const p = getGroundPoint(x, y);
            if(!p) return;

            if(state.selectedAbility !== null) {
                abilityZone.position.copy(p); abilityZone.position.y = 0.1;
                abilityZone.visible = true;
                // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –∫–ª–∏–∫ —Å—Ä–∞–∑—É –∫–∞—Å—Ç—É–µ—Ç
                canvas.onmouseup = () => castAbility(state.selectedAbility, p);
            } else if(settings.control === 'tap') {
                state.moveTarget = p;
                moveIndicator.position.copy(p); moveIndicator.position.y=0.1; moveIndicator.visible=true;
            }
        }

        // ============ –õ–û–ì–ò–ö–ê ============
        function startGame(type) {
            selectedHeroType = type;
            heroData = HEROES[type];
            state.maxHp = heroData.hp; state.hp = heroData.hp;
            state.maxMp = heroData.mp; state.mp = heroData.mp;

            document.getElementById('heroSelect').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('heroPortrait').innerHTML = heroData.icon + '<div class="hero-level">1</div>';

            // –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï
            socket.emit('joinGame', { heroType: type, hp: state.hp, maxHp: state.maxHp });
        }

        socket.on('currentPlayers', (players) => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            document.getElementById('settingsBtn').style.display = 'flex';
            
            mySocketId = socket.id;
            hero = createHeroMesh(selectedHeroType, true);
            
            Object.keys(players).forEach(id => {
                if(id !== mySocketId) {
                    const p = players[id];
                    const other = createHeroMesh(p.heroType, false);
                    other.position.set(p.x, 0, p.z);
                    otherPlayers[id] = other;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –Ω–∞ –º–∏–Ω–∏–∫–∞—Ä—Ç–µ
                    const dot = document.createElement('div');
                    dot.className = 'minimap-dot minimap-enemy';
                    dot.id = 'mmBot'+id;
                    document.querySelector('.minimap').appendChild(dot);
                }
            });
            createAbilitiesUI();
            animate();
        });

        socket.on('newPlayer', (p) => {
            const other = createHeroMesh(p.heroType, false);
            other.position.set(p.x, 0, p.z);
            otherPlayers[p.id] = other;
            const dot = document.createElement('div');
            dot.className = 'minimap-dot minimap-enemy';
            dot.id = 'mmBot'+p.id;
            document.querySelector('.minimap').appendChild(dot);
        });

        socket.on('playerMoved', (p) => {
            if(otherPlayers[p.id]) {
                otherPlayers[p.id].position.set(p.x, 0, p.z);
                otherPlayers[p.id].rotation.y = p.rot;
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–∫–∞—Ä—Ç—É –≤—Ä–∞–≥–∞
                const dot = document.getElementById('mmBot'+p.id);
                if(dot) {
                    dot.style.left = (55 + p.x) + 'px';
                    dot.style.top = (55 - p.z) + 'px';
                }
            }
        });

        socket.on('playerDisconnected', (id) => {
            if(otherPlayers[id]) {
                scene.remove(otherPlayers[id]);
                delete otherPlayers[id];
                const dot = document.getElementById('mmBot'+id);
                if(dot) dot.remove();
            }
        });

        socket.on('remoteAbility', (data) => {
            // –≠—Ñ—Ñ–µ–∫—Ç –æ—Ç –¥—Ä—É–≥–∏—Ö (–ø—Ä–æ—Å—Ç–æ–π –≤–∑—Ä—ã–≤)
            createExplosion(data.target, 0xff0000);
            showDamage(data.target, "–ë–ê–ú!", "ability");
        });

        // ============ –°–ü–û–°–û–ë–ù–û–°–¢–ò –ò UI ============
        function createAbilitiesUI() {
            const panel = document.getElementById('abilitiesPanel');
            panel.innerHTML = '';
            heroData.abilities.forEach((ab, i) => {
                const el = document.createElement('div');
                el.className = 'ability';
                el.style.background = `linear-gradient(135deg, ${hexToRgba(ab.color,0.9)} 0%, ${hexToRgba(ab.color,0.5)} 100%)`;
                el.innerHTML = `<span class="ability-icon">${ab.icon}</span><span class="ability-key">${ab.name}</span><div class="ability-mana">üíß${ab.mana}</div><div class="ability-cd" id="cd${i}"></div>`;
                el.addEventListener('touchstart', (e)=>{e.stopPropagation(); selectAbility(i)});
                el.addEventListener('mousedown', (e)=>{e.stopPropagation(); selectAbility(i)});
                panel.appendChild(el);
            });
            document.getElementById('cancelBtn').onclick = () => {
                state.selectedAbility=null; abilityZone.visible=false;
                document.querySelectorAll('.ability').forEach(a=>a.classList.remove('selected'));
                document.getElementById('cancelBtn').classList.remove('active');
            };
        }

        function selectAbility(i) {
            if(state.cooldowns[heroData.abilities[i].key] > 0 || state.mp < heroData.abilities[i].mana) return;
            state.selectedAbility = i;
            document.querySelectorAll('.ability').forEach(a=>a.classList.remove('selected'));
            document.querySelectorAll('.ability')[i].classList.add('selected');
            document.getElementById('cancelBtn').classList.add('active');
            abilityZone.visible = true;
            abilityZone.position.copy(hero.position);
        }

        function castAbility(i, pos) {
            const ab = heroData.abilities[i];
            state.mp -= ab.mana;
            state.cooldowns[ab.key] = ab.cd;
            
            // –í–∏–∑—É–∞–ª (–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
            createExplosion(pos, ab.color);
            showDamage(pos, "–ë–ê–ú!", "ability");
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            socket.emit('abilityUsed', { abilityIndex: i, target: pos });
            
            state.selectedAbility=null; abilityZone.visible=false;
            document.querySelectorAll('.ability').forEach(a=>a.classList.remove('selected'));
            document.getElementById('cancelBtn').classList.remove('active');
        }

        // ============ –≠–§–§–ï–ö–¢–´ ============
        function createExplosion(pos, color) {
            const group = new THREE.Group();
            for(let i=0; i<10; i++) {
                const m = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({color:color}));
                m.position.set((Math.random()-0.5)*2, Math.random()*2, (Math.random()-0.5)*2);
                group.add(m);
            }
            group.position.copy(pos);
            scene.add(group);
            setTimeout(()=>scene.remove(group), 500);
        }

        function showDamage(pos, text, type) {
            const div = document.createElement('div');
            div.className = `damage-popup ${type}`;
            div.textContent = text;
            const v = pos.clone(); v.y+=3; v.project(camera);
            div.style.left = ((v.x+1)/2*window.innerWidth)+'px';
            div.style.top = ((-v.y+1)/2*window.innerHeight)+'px';
            document.body.appendChild(div);
            setTimeout(()=>div.remove(), 1000);
        }

        function hexToRgba(hex, a) {
            const r = (hex >> 16) & 255, g = (hex >> 8) & 255, b = hex & 255;
            return `rgba(${r},${g},${b},${a})`;
        }

        // ============ –ù–ê–°–¢–†–û–ô–ö–ò ============
        function toggleSettings() {
            const el = document.getElementById('settingsModal');
            el.style.display = el.style.display==='flex'?'none':'flex';
        }
        function setGraphics(lvl) {
            document.getElementById('gfx-low').classList.toggle('active', lvl==='low');
            document.getElementById('gfx-high').classList.toggle('active', lvl==='high');
            if(lvl==='high') { renderer.setPixelRatio(window.devicePixelRatio); mainLight.castShadow=true; }
            else { renderer.setPixelRatio(0.8); mainLight.castShadow=false; }
        }
        function setControl(type) {
            settings.control = type;
            document.getElementById('ctrl-tap').classList.toggle('active', type==='tap');
            document.getElementById('ctrl-joy').classList.toggle('active', type==='joy');
            document.getElementById('joystickZone').style.display = type==='joy'?'block':'none';
        }

        // ============ –¶–ò–ö–õ ============
        let updateTimer = 0;
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            if(!hero) return;

            // –î–≤–∏–∂–µ–Ω–∏–µ
            let moved = false;
            if(settings.control === 'joy' && state.joystickActive) {
                const spd = CONFIG.HERO_SPEED * 3;
                hero.position.x += state.joystickVector.x * spd;
                hero.position.z += state.joystickVector.y * spd;
                hero.lookAt(hero.position.x + state.joystickVector.x, 0.75, hero.position.z + state.joystickVector.y);
                moved = true;
                moveIndicator.visible = false;
            } else if(settings.control === 'tap' && state.moveTarget) {
                const dir = new THREE.Vector3().subVectors(state.moveTarget, hero.position);
                dir.y=0;
                if(dir.length() > 0.2) {
                    dir.normalize();
                    hero.position.add(dir.multiplyScalar(CONFIG.HERO_SPEED));
                    hero.lookAt(state.moveTarget.x, 0.75, state.moveTarget.z);
                    moved = true;
                } else {
                    state.moveTarget = null;
                    moveIndicator.visible = false;
                }
            }

            // –ö–∞–º–µ—Ä–∞
            camera.position.x += (hero.position.x - camera.position.x) * 0.1;
            camera.position.z += (hero.position.z + 20 - camera.position.z) * 0.1;
            camera.lookAt(hero.position.x, 0, hero.position.z);

            // –ö—É–ª–¥–∞—É–Ω—ã –∏ UI
            heroData.abilities.forEach((ab, i) => {
                if(state.cooldowns[ab.key] > 0) {
                    state.cooldowns[ab.key] -= delta;
                    const el = document.getElementById('cd'+i);
                    if(el) { el.textContent = Math.ceil(state.cooldowns[ab.key]); el.classList.add('active'); }
                    if(state.cooldowns[ab.key] <= 0 && el) el.classList.remove('active');
                }
            });
            
            if(state.mp < state.maxMp) state.mp += delta * 5;
            document.getElementById('hpBar').style.width = (state.hp/state.maxHp*100)+'%';
            document.getElementById('mpBar').style.width = (state.mp/state.maxMp*100)+'%';
            document.getElementById('mmHero').style.left = (55 + hero.position.x)+'px';
            document.getElementById('mmHero').style.top = (55 - hero.position.z)+'px';

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            updateTimer += delta;
            if(updateTimer > 0.05 && moved) {
                socket.emit('playerUpdate', { x: hero.position.x, z: hero.position.z, rot: hero.rotation.y, hp: state.hp });
                updateTimer = 0;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
